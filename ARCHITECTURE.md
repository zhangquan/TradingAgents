# TradingAgents 架构说明

## 新的部署架构

### 概述

TradingAgents 现在采用**集成式架构**，前端构建文件直接集成到后端服务中，简化了部署和管理。

### 架构变更

#### 之前的架构
```
用户请求 → Nginx → 前端服务器 (Port 3000) → 静态文件
                → 后端服务器 (Port 8000) → API 响应
```

#### 现在的架构

**直接模式：**
```
用户请求 → 后端服务器 (Port 8000) → 静态文件 + API 响应
```

**Nginx 代理模式：**
```
用户请求 → Nginx (Port 80) → 后端服务器 (Port 8000) → 静态文件 + API 响应
```

## 技术实现

### 1. 前端构建集成

- **构建目标**: 前端构建文件输出到 `backend/static/` 目录
- **配置文件**: `frontend/vite.config.ts` 中设置 `outDir: '../backend/static'`
- **自动清理**: 构建时自动清理旧文件 (`emptyOutDir: true`)

### 2. 后端静态文件服务

- **静态文件挂载**: FastAPI 挂载 `/static` 路径提供静态文件
- **SPA 路由支持**: 所有未匹配路径返回 `index.html` 支持前端路由
- **API 路径保护**: 确保 API 路径不被 SPA 路由覆盖

### 3. 智能路由处理

```python
# 后端路由优先级
1. API 路由 (/api/*, /docs, /health 等)
2. 静态文件 (存在的文件直接返回)
3. SPA 路由 (返回 index.html)
```

## 优势

### 1. 简化部署
- **单一服务**: 只需启动一个后端服务
- **减少端口**: 不再需要独立的前端端口
- **统一管理**: 前后端通过同一个进程管理

### 2. 提高性能
- **减少网络跳转**: 静态文件和 API 来自同一服务
- **内置缓存**: FastAPI 自带的静态文件缓存
- **减少延迟**: 消除前后端服务间的通信延迟

### 3. 运维简化
- **单一日志源**: 所有请求日志集中在后端
- **简化监控**: 只需监控一个服务的健康状态
- **容器友好**: 更适合 Docker 单容器部署

## 文件结构

```
TradingAgents/
├── backend/
│   ├── static/              # 前端构建文件（自动生成）
│   │   ├── index.html
│   │   ├── assets/
│   │   │   ├── *.js
│   │   │   ├── *.css
│   │   │   └── *.svg
│   │   └── *.svg
│   ├── main.py              # 集成静态文件服务
│   └── ...
├── frontend/
│   ├── vite.config.ts       # 构建到 ../backend/static
│   └── ...
└── start-prod.sh            # 统一启动脚本
```

## 配置详解

### 前端构建配置 (vite.config.ts)

```typescript
export default defineConfig({
  build: {
    outDir: '../backend/static',  // 构建到后端目录
    emptyOutDir: true,           // 清理旧文件
    // ... 其他优化配置
  }
})
```

### 后端静态服务配置 (main.py)

```python
# 挂载静态文件
app.mount("/static", StaticFiles(directory=static_dir), name="static")

# SPA 路由支持
@app.get("/{full_path:path}")
async def serve_spa(request: Request, full_path: str):
    # 智能路由处理逻辑
    # ...
```

## 部署方式对比

| 特性 | 集成模式 | 分离模式（旧） |
|------|----------|----------------|
| 服务数量 | 1 个 | 2 个 |
| 端口数量 | 1 个 | 2 个 |
| 内存使用 | 较低 | 较高 |
| 启动时间 | 较快 | 较慢 |
| 网络延迟 | 较低 | 较高 |
| 部署复杂度 | 简单 | 复杂 |
| 扩展性 | 垂直扩展 | 水平扩展 |

## 兼容性

### Nginx 代理支持
- 完全兼容现有 Nginx 配置
- 所有请求转发到后端统一处理
- 支持 WebSocket 代理

### 开发环境
- 开发环境仍使用独立前端服务器 (Vite dev server)
- 热重载和开发工具功能不受影响

## 迁移指南

### 从分离架构迁移

1. **停止旧服务**
   ```bash
   ./stop-prod.sh
   ```

2. **构建前端到新位置**
   ```bash
   cd frontend && npm run build
   ```

3. **启动集成服务**
   ```bash
   ./start-prod.sh
   ```

### 回退到分离架构（如需要）

1. 修改 `frontend/vite.config.ts` 中的 `outDir` 为 `'dist'`
2. 使用开发环境脚本或手动启动前后端服务

## 监控和调试

### 日志统一
- 所有访问日志记录在后端日志中
- API 和静态文件请求统一跟踪

### 调试工具
- 浏览器开发者工具正常工作
- 网络请求统一显示为后端地址

### 性能监控
- 单一服务监控点
- 统一的健康检查端点

## 最佳实践

### 1. 缓存策略
- 静态资源设置长期缓存
- API 响应根据需要设置缓存头

### 2. 安全考虑
- 确保 API 路径优先级高于静态文件
- 验证静态文件访问权限

### 3. 性能优化
- 启用 Gzip 压缩
- 使用 CDN 分发静态资源（如需要）

这种集成架构特别适合中小规模部署，在保持功能完整性的同时大大简化了运维复杂度。
